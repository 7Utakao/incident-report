# ホーム画面 改善ガイド（Incident Report System）

> 目的：**明るく分かりやすいホーム**に刷新し、数字は**すべて実データ連動**。会社レベルと個人レベルの2本指標を導入し、徐々に上がりにくくなるレベル設計を採用。レベルアップ時は当日だけお祝いメッセージ（花火）を表示する。

---

## 1. 画面仕様（完成形）
- ヒーロー：マスコット画像＋バブル
  - 文言は 3 パターンをランダム表示
    1) 「チーム全体で学び、成長していきます。」
    2) 「今日の報告は X 件です。計 Y 件投稿されました。あと Z 件でレベルが上がります。」
    3) 「こんにちは。日々の改善・気づきを共有して、みんなで前に進みましょう。」
  - **レベルアップ当日**は上記の代わりに「おめでとうございます！レベルが上がりました 🎆」を優先表示
- レベルカード：
  - 会社レベル（全社の投稿合計をXPとして換算）
  - 個人レベル（ユーザーの投稿合計をXPとして換算）
  - それぞれ：`Lv N 〈称号〉`、進捗バー、次レベルまでの件数
- 最近の報告：最新 5 件（タイトル、カテゴリ、要約、作成日）
- クイックアクションは削除
- 全体トーン：今どきの明るい配色（白 / パステル / 薄いシャドウ / 角丸）

> 参考：右側の `Home_demo.html` のUIを Nuxt ページに移植し、データ連動させる。

---

## 2. データ連携（API 契約）
### 2.1 必須エンドポイント
- **総件数 / 今日件数**
  - `GET /stats/categories?scope=all` → `{ totalReports }`
  - `GET /stats/categories?scope=today&tz=Asia/Tokyo` → `{ totalReports }`
  - ※ 既存の集計APIを流用。スケール時は `/stats/summary` に切り出しも可。
- **最近の報告**
  - `GET /reports?limit=5` → `{ items:[{ id,title,summary,category,categories,createdAt }] }`

### 2.2 マッピング
- 会社XP = `/stats.categories(scope=all).totalReports`
- 個人XP = `GET /reports?authorId=me&countOnly=true`（なければ一時的に `/me` で事前取得→フロントでフィルタ）
- 今日件数 = `/stats.categories(scope=today)`
- 最近5件 = `/reports?limit=5`

### 2.3 認証
- フロントは **IDトークン**を `Authorization: Bearer <idToken>` で送付（ダッシュボードと同じ）

---

## 3. レベル設計（会社 / 個人 共通）
### 3.1 称号（9段階）
1. ひよっこ  
2. たねまき  
3. 見習い  
4. 研究者  
5. 冒険者  
6. 達人  
7. 師範  
8. 先導者  
9. 伝道師

### 3.2 進行度（必要件数）
- レベル *n → n+1* に必要な件数：`need(n) = round(5 + n^1.5)`
- テーブル：
  - 1→2: **6**、2→3: **8**、3→4: **10**、4→5: **13**、
  - 5→6: **16**、6→7: **20**、7→8: **24**、8→9: **28**
- 累積到達（目安）：Lv2=6、Lv3=14、Lv4=24、Lv5=37、Lv6=53、Lv7=73、Lv8=97、Lv9=125
- 直感：序盤は上がりやすく、後半は段階的に重く（“徐々に難しくなる”）

### 3.3 実装指針
- XP はまず **投稿件数**のみで算出（将来、カテゴリ多様性・他者からのリアクションで加点）
- フロント表示は `現在レベル / 称号 / 進捗率 / 次レベルまでの残数`
- 会社XP：全件数、個人XP：ログインユーザーの件数

### 3.4 レベルアップ検知
- サーバ側で `levels:{ org:{level,lastLeveledAt}, me:{level,lastLeveledAt} }` を返すか、
  もしくはフロントで前回レベルを `localStorage` に保存して比較
- **当日内**にレベルが上がったら、マスコットのメッセージを
  `「おめでとうございます！レベルが〈旧〉→〈新〉になりました 🎆」` に差し替え（当日 23:59 まで）

---

## 4. アセット（マスコット）
- まるい可愛いキャラ画像（PNG/SVG）を配置（仮：Placehold 画像）。
- 後で画像生成（例：Bedrock Stable Diffusion / Firefly 等）を行う。プロンプトとカラーパレットは別途メモ。

---

## 5. 実装タスク（Cline向け）
1) **API 連携**  
- `/stats/categories?scope=all|today` を呼び、`totalReports` を取得。会社XPと今日件数に使用。
- `/reports?limit=5` を呼び、最近5件を描画。カテゴリは `category || categories[0]` を表示。

2) **個人XP**  
- `/reports?authorId=me&countOnly=true` が無ければ、暫定で `/reports?limit=50` 取得→フロントで `authorId===me` を集計。
- 将来は軽量エンドポイントへ差し替え。

3) **レベル算出**  
- 上記 `need(n)` を用いて、XP→レベル/進捗/残件数を算出するヘルパーを共通化。

4) **レベルアップ演出**  
- サーバが `lastLeveledAt` を返せる場合はそれを優先。無ければフロントで前回レベルを `localStorage('level.org'/'level.me')` に保存し、当日中はお祝い文を表示。

5) **UI 組み込み**  
- `Home_demo.html` のマークアップ/スタイルを Nuxt ページに移植。
- ヒーローコピーは以下の固定文に差し替え可能：
  > 現場のつまずき・気づき・改善案を安全に匿名化して蓄積し、カテゴリ別に可視化して学び合う社内プラットフォームです。AI が要約とタグ付けを補助します。

6) **テスト**  
- 新規投稿を 1→2 件追加し、個人/会社のバーと“残り件数”が増減することを確認。
- 当日にレベル境界を跨ぐテストでお祝いメッセージが出ることを確認。

---

## 6. 受け入れ基準（AC）
- [ ] ホームの数字が **すべて API 由来**（ハードコード無し）
- [ ] 会社/個人の 2 本バーが表示され、**残件数**と**進捗率**が期待通り
- [ ] 最近5件が DB の最新と一致
- [ ] レベルアップ当日、マスコットが祝辞（🎆）を出す
- [ ] 明るい配色と現代的な余白・角丸・シャドウで統一

---

## 7. よくある落とし穴
- 今日件数の集計は **タイムゾーン（Asia/Tokyo）** を必ず考慮
- カテゴリが配列のときの表示優先順位
- レベルテーブルの境界（ちょうど0件で上がる時）は `>=` 判定でバグらないように

---

## 8. 完了定義（DoD）
- スクリーンショット：ホーム全景、レベル2本、最近の報告
- `/stats/categories?scope=all|today` と `/reports?limit=5` の JSON を添付
- 仕様・UI差分が PR に反映されていること

