<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒ›ãƒ¼ãƒ ï¼ˆãƒ‡ãƒ¢ï¼‰â€” ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå­¦ç¿’ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: light; }
    body { background: radial-gradient(1200px 600px at 50% -20%, #e6f1ff 0%, #f6fbff 35%, #ffffff 70%); }
    <style>
    :root { color-scheme: light; }
    /* èƒŒæ™¯ã‚’ã‚„ã•ã—ã„ãƒŸãƒ³ãƒˆç³»ã« */
    body { background: radial-gradient(1200px 600px at 50% -20%, #ecfdf5 0%, #f6fff9 40%, #ffffff 72%); }
    /* å¹ãå‡ºã—ã®ã—ã£ã½ */
    .bubble { position: relative; }
    .bubble:before { content: ""; position: absolute; left: -6px; top: 14px; width: 12px; height: 12px; background: white; border: 1px solid rgba(0,0,0,0.06); transform: rotate(45deg); border-right-color: transparent; border-bottom-color: transparent; }
  </style>
</head>
<body class="min-h-screen text-gray-900">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒ‡ãƒ¢ï¼‰ -->
  <header class="sticky top-0 z-10 backdrop-blur bg-white/60 border-b">
    <div class="max-w-7xl mx-auto px-6 h-14 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-7 h-7 rounded-full bg-lime-500/15 grid place-items-center text-lime-600">ğŸŒ±</div>
        <span class="font-semibold tracking-tight">å ±å‘Šã‚·ã‚¹ãƒ†ãƒ </span>
      </div>
      <nav class="text-sm text-gray-500 flex items-center gap-6">
        <a href="#" class="hover:text-gray-700">ãƒ›ãƒ¼ãƒ </a>
        <a href="#" class="hover:text-gray-700">å ±å‘Šä¸€è¦§</a>
        <a href="#" class="hover:text-gray-700">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-8 space-y-8">
    <!-- ãƒ’ãƒ¼ãƒ­ãƒ¼ï¼šèª¬æ˜æ–‡ + ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ -->
    <section class="rounded-2xl border bg-white/70 backdrop-blur p-6 shadow-sm">
      <div class="grid grid-cols-1 md:grid-cols-[auto,1fr] gap-6 items-center">
        <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼ˆä»®ï¼‰ -->
        <div class="flex items-center gap-4">
          <div class="relative">
            <!-- é€éèƒŒæ™¯ã®æƒ³å®šï¼šå¾Œã§å·®ã—æ›¿ãˆ -->
            <img id="mascot" src="https://placehold.co/96x96/png?text=%F0%9F%98%8A&bg=transparent" alt="ãƒã‚¹ã‚³ãƒƒãƒˆ" class="w-16 h-16 md:w-24 md:h-24 rounded-full object-contain bg-transparent ring-1 ring-emerald-100" />
          </div>
          <!-- å¹ãå‡ºã—ï¼ˆçŸ­æ–‡ï¼‰ -->
          <div id="bubble" class="bubble bg-white border border-black/5 rounded-2xl px-4 py-3 text-sm md:text-base text-gray-800 shadow-sm">â€”</div>
        </div>
        <!-- èª¬æ˜æ–‡ï¼ˆãƒ’ãƒ¼ãƒ­ãƒ¼ã‚³ãƒ”ãƒ¼ï¼‰ -->
        <div class="text-sm md:text-base leading-relaxed text-gray-700">
          ç¾å ´ã®ã¤ã¾ãšããƒ»æ°—ã¥ããƒ»æ”¹å–„æ¡ˆã‚’å®‰å…¨ã«åŒ¿ååŒ–ã—ã¦è“„ç©ã—ã€ã‚«ãƒ†ã‚´ãƒªã§è¦‹ãˆã‚‹åŒ–ã™ã‚‹ç¤¾å†…ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚å…¥åŠ›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã€‚AI ãŒè¦ç´„ã¨ã‚¿ã‚°ä»˜ã‘ã‚’æ‰‹ä¼ã„ã¾ã™ã€‚
        </div>
      </div>
    </section>

    <!-- ãƒ¬ãƒ™ãƒ«çŠ¶æ³ï¼šä¼šç¤¾ / å€‹äºº ã®2æœ¬ãƒãƒ¼ -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="rounded-2xl border bg-white p-6 shadow-sm">
        <div class="text-sm text-gray-500">ä¼šç¤¾ãƒ¬ãƒ™ãƒ«</div>
        <div id="orgLevelLabel" class="mt-1 text-xl font-semibold">Lv â€” â€”</div>
        <div class="mt-4 h-2 rounded-full bg-gray-100 overflow-hidden">
          <div id="orgLevelBar" class="h-full rounded-full bg-emerald-500" style="width:0%"></div>
        </div>
        <div id="orgRemain" class="mt-2 text-xs text-gray-500">æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¾ã§ â€” ä»¶</div>
      </div>

      <div class="rounded-2xl border bg-white p-6 shadow-sm">
        <div class="text-sm text-gray-500">å€‹äººãƒ¬ãƒ™ãƒ«</div>
        <div id="meLevelLabel" class="mt-1 text-xl font-semibold">Lv â€” â€”</div>
        <div class="mt-4 h-2 rounded-full bg-gray-100 overflow-hidden">
          <div id="meLevelBar" class="h-full rounded-full bg-lime-500" style="width:0%"></div>
        </div>
        <div id="meRemain" class="mt-2 text-xs text-gray-500">æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¾ã§ â€” ä»¶</div>
      </div>
    </section>

    <!-- æœ€è¿‘ã®å ±å‘Š -->
    <section class="rounded-2xl border bg-white p-6 shadow-sm">
      <div class="flex items-center justify-between">
        <h2 class="text-base font-semibold">æœ€è¿‘ã®å ±å‘Š</h2>
        <a href="#" class="text-sm text-emerald-700 hover:underline">ã™ã¹ã¦ã®å ±å‘Šã‚’è¦‹ã‚‹</a>
      </div>
      <div id="recent" class="mt-4 divide-y">
        <!-- JSã§æŒ¿å…¥ -->
      </div>
    </section>

    <p class="text-xs text-gray-400">â€» ã“ã®ãƒ‡ãƒ¢ã¯ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã§è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚API é€£æºæ™‚ã¯ Cline ã« <code>API_BASE</code> ã¨ Authorization ãƒ˜ãƒƒãƒ€ãƒ¼ã®å·®ã—è¾¼ã¿ã‚’ä¾é ¼ã—ã¦ãã ã•ã„ã€‚</p>
  </main>

  <script>
    // ==============================
    //  è¨­å®šï¼ˆAPI_BASE ã‚’æŒ‡å®šã™ã‚‹ã¨æ¥ç¶šã‚’è©¦ã¿ã‚‹ï¼‰
    // ==============================
    const API_BASE = window.API_BASE || '';
    // ç¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå½“æ—¥ã ã‘è¡¨ç¤ºã™ã‚‹æƒ³å®šï¼‰
    const LEVELED_UP_TODAY = false; // API ã§åˆ¤å®šã—ã¦ç½®ãæ›ãˆ

    // ãƒ¬ãƒ™ãƒ«åï¼ˆä¼šç¤¾ / å€‹äºº å…±é€šï¼‰
    const LEVEL_NAMES = ['ã²ã‚ˆã£ã“','ãŸã­ã¾ã','è¦‹ç¿’ã„','ç ”ç©¶è€…','å†’é™ºè€…','é”äºº','å¸«ç¯„','å…ˆå°è€…','ä¼é“å¸«'];
    // ãƒ¬ãƒ™ãƒ« n -> n+1 ã«å¿…è¦ãªä»¶æ•°ï¼ˆå¢—åŠ ã—ã¦ã„ãï¼‰
    const STEP_NEED = [6,8,10,13,16,20,24,28]; // 1â†’2, 2â†’3 ...

    const demo = {
      todayCount: 3,
      totalCount: 47,
      orgXp: 47,    // ä¼šç¤¾åˆè¨ˆã®å ±å‘Šæ•° = XP
      meXp: 12,     // å€‹äººã®å ±å‘Šæ•° = XP
      recent: [
        { title:'æ©Ÿå¯†è³‡æ–™ã®èª¤é€ä¿¡ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ', category:'æƒ…å ±æ¼æ´©ãƒ»å¼·æœæ”¯æ´', createdAt:'2025-08-20', text:'èª¤ã£ãŸå®›å…ˆã«è³‡æ–™ã‚’é€ä»˜ã€‚å·®ã—æˆ»ã—æ‰‹é †ã‚’æ•´å‚™ã—ã¾ã—ãŸã€‚' },
        { title:'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼', category:'ã‚·ã‚¹ãƒ†ãƒ éšœå®³', createdAt:'2025-08-19', text:'æ¥ç¶šãƒ—ãƒ¼ãƒ«æ¯æ¸‡ã€‚ç›£è¦–é–¾å€¤ã¨ãƒªãƒˆãƒ©ã‚¤æ–¹é‡ã‚’è¦‹ç›´ã—ã€‚' },
        { title:'é¡§å®¢æƒ…å ±ã®å…¥åŠ›ãƒŸã‚¹', category:'ä½œæ¥­ãƒŸã‚¹', createdAt:'2025-08-18', text:'ä½æ‰€ã®ç•ªåœ°ãšã‚Œã€‚ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã€‚' }
      ]
    };

    // XP ã‹ã‚‰ãƒ¬ãƒ™ãƒ«æƒ…å ±ã‚’ç®—å‡º
    function levelFromXp(xp){
      let lvl = 1; // 1=ã²ã‚ˆã£ã“
      let needIdx = 0, acc = 0;
      while (needIdx < STEP_NEED.length && xp >= acc + STEP_NEED[needIdx]) {
        acc += STEP_NEED[needIdx];
        needIdx++; lvl++;
      }
      const nextNeed = needIdx < STEP_NEED.length ? STEP_NEED[needIdx] : STEP_NEED[STEP_NEED.length-1];
      const inLevel = xp - acc;
      const remain = Math.max(0, nextNeed - inLevel);
      const pct = Math.min(100, Math.round(inLevel / nextNeed * 100));
      const name = LEVEL_NAMES[Math.min(lvl-1, LEVEL_NAMES.length-1)];
      return { lvl, name, remain, pct };
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ3ç¨®é¡ãƒ»çŸ­æ–‡ï¼‰
    function buildMessages({todayCount,totalCount,remain}){
      return [
        `å­¦ã³ã‚’åˆ†ã‹ã¡åˆãŠã†ã€‚`,
        `ä»Šæ—¥ã¯${todayCount}ä»¶ã€‚è¨ˆ${totalCount}ä»¶ã€‚ã‚ã¨${remain}ä»¶ã§ãƒ¬ãƒ™ãƒ«UPã€‚`,
        `æ°—ã¥ã„ãŸã‚‰ã€ã™ãæ›¸ã“ã†ã€‚`
      ];
    }

    function tagColor(cat){
      const map = [
        { bg:'bg-emerald-50', text:'text-emerald-700' },
        { bg:'bg-amber-50',   text:'text-amber-700' },
        { bg:'bg-rose-50',    text:'text-rose-700' },
        { bg:'bg-sky-50',     text:'text-sky-700' },
        { bg:'bg-lime-50',    text:'text-lime-700' },
        { bg:'bg-violet-50',  text:'text-violet-700' }
      ];
      // ç°¡æ˜“ãƒãƒƒã‚·ãƒ¥ã§å®‰å®šè‰²
      let h = 0; const s = String(cat||'');
      for(let i=0;i<s.length;i++){ h = (h*31 + s.charCodeAt(i)) >>> 0; }
      return map[h % map.length];
    }

    function setBubble(msgs){
      const el = document.getElementById('bubble');
      const msg = LEVELED_UP_TODAY ? `ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ãƒ¬ãƒ™ãƒ«ãŒä¸ŠãŒã‚Šã¾ã—ãŸ ğŸ†` : msgs[Math.floor(Math.random()*msgs.length)];
      el.textContent = msg;
    }

    function renderLevels(orgXp, meXp){
      const o = levelFromXp(orgXp);
      const m = levelFromXp(meXp);
      document.getElementById('orgLevelLabel').textContent = `Lv ${o.lvl} ${o.name}`;
      document.getElementById('orgLevelBar').style.width = `${o.pct}%`;
      document.getElementById('orgRemain').textContent = `æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¾ã§ ${o.remain} ä»¶`;

      document.getElementById('meLevelLabel').textContent = `Lv ${m.lvl} ${m.name}`;
      document.getElementById('meLevelBar').style.width = `${m.pct}%`;
      document.getElementById('meRemain').textContent = `æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¾ã§ ${m.remain} ä»¶`;

      return {remainForMessage: o.remain};
    }

    function renderRecent(items){
      const wrap = document.getElementById('recent');
      wrap.innerHTML = '';
      if(!items || !items.length){
        wrap.innerHTML = `<div class="py-8 text-center text-gray-400">ã¾ã å ±å‘ŠãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
        return;
      }
      for(const it of items){
        const row = document.createElement('div');
        row.className = 'py-3 grid grid-cols-[7rem,1fr,auto] items-start gap-3';
        const color = tagColor(it.category);
        row.innerHTML = `
          <span class="inline-flex w-28 shrink-0 justify-center rounded-full ${color.bg} ${color.text} text-[11px] px-2 py-1 whitespace-nowrap overflow-hidden text-ellipsis">${(it.category||'â€”')}</span>
          <div class="min-w-0">
            <div class="font-medium truncate">${it.title||'ï¼ˆç„¡é¡Œï¼‰'}</div>
            <div class="text-xs text-gray-500 line-clamp-2">${it.text||''}</div>
          </div>
          <div class="ml-auto text-xs text-gray-400">${it.createdAt||''}</div>
        `;
        wrap.appendChild(row);
      }
    }
      for(const it of items){
        const row = document.createElement('div');
        row.className = 'py-3 grid grid-cols-[7rem,1fr,auto] items-start gap-3';
        // ã‚¿ã‚°ã¯ä¸€å®šå¹…ã§çœç•¥è¡¨ç¤ºï¼ˆã‚¿ã‚¤ãƒˆãƒ«ç¸¦ä½ç½®ã‚’æƒãˆã‚‹ï¼‰
        const color = tagColor(it.category);
        row.innerHTML = `
          <span class="inline-flex w-28 shrink-0 justify-center rounded-full ${color.bg} ${color.text} text-[11px] px-2 py-1 whitespace-nowrap overflow-hidden text-ellipsis">${(it.category||'â€”')}</span>
          <div class="min-w-0">
            <div class="font-medium truncate">${it.title||'ï¼ˆç„¡é¡Œï¼‰'}</div>
            <div class="text-xs text-gray-500 line-clamp-2">${it.text||''}</div>
          </div>
          <div class="ml-auto text-xs text-gray-400">${it.createdAt||''}</div>
        `;
        wrap.appendChild(row);
      }
    }

    async function init(){
      let today = demo.todayCount, total = demo.totalCount, orgXp = demo.orgXp, meXp = demo.meXp, recent = demo.recent;

      // API é€£æºï¼ˆå¤±æ•—æ™‚ã¯ãƒ‡ãƒ¢å€¤ï¼‰
      if(API_BASE){
        try{
          // ä¾‹ï¼š/stats/categories?scope=all ã‹ã‚‰ totalReports ã‚’å–å¾—
          const resAll = await fetch(`${API_BASE}/stats/categories?scope=all`);
          if(resAll.ok){
            const j = await resAll.json();
            total = j.totalReports ?? total;
            orgXp = j.totalReports ?? orgXp;
          }
          // ä¾‹ï¼š/stats/categories?scope=today ã‹ã‚‰ä»Šæ—¥ã®ä»¶æ•°
          const resToday = await fetch(`${API_BASE}/stats/categories?scope=today&tz=Asia/Tokyo`);
          if(resToday.ok){
            const j = await resToday.json();
            today = j.totalReports ?? today;
          }
          // æœ€è¿‘ã®å ±å‘Š
          const resRecent = await fetch(`${API_BASE}/reports?limit=5`);
          if(resRecent.ok){
            const j = await resRecent.json();
            recent = (j.items||j.reports||[]).map(r=>({
              title: r.title || r.summary || 'ï¼ˆç„¡é¡Œï¼‰',
              category: r.category || (r.categories && r.categories[0]) || 'â€”',
              text: r.summary || r.body || '',
              createdAt: r.createdAt || ''
            }));
          }
        }catch(e){ console.warn('APIé€£æºã«å¤±æ•—ï¼ˆãƒ‡ãƒ¢ã§è¡¨ç¤ºï¼‰', e); }
      }

      // ãƒ¬ãƒ™ãƒ«æç”»
      const {remainForMessage} = renderLevels(orgXp, meXp);

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      const msgs = buildMessages({todayCount: today, totalCount: total, remain: remainForMessage});
      setBubble(msgs);

      // æœ€è¿‘ã®å ±å‘Š
      renderRecent(recent);
    }

    init();
  </script>
</body>
</html>
