# デプロイ設定手順書

## 概要

フロントエンド（Amplify）とバックエンド（Lambda）を分離したデプロイ構成に変更しました。
これにより、「モグラ叩き」を回避し、確実で保守しやすいデプロイが可能になります。

## アーキテクチャ

### フロントエンド（Amplify）

- **責任**: Nuxt.js アプリケーションのビルド・ホスティングのみ
- **生成物**: `.output/public`（静的サイト）
- **SSM Secrets**: 無効化（不要なノイズを削除）

### バックエンド（GitHub Actions）

- **責任**: Lambda 関数の独立デプロイ
- **生成物**: `index.js`のみを zip ファイル化
- **AWS SDK**: 完全バンドル（外部依存なし）

## 設定手順

### 1. Amplify 設定

#### 1.1 SSM Secrets 無効化

1. Amplify コンソール → アプリ選択
2. 「App settings」→「Environment variables」
3. SSM Secrets 機能を無効化

#### 1.2 環境変数設定

以下の環境変数を Amplify コンソールで設定：

```
NUXT_PUBLIC_API_BASE=https://your-lambda-function-url
NUXT_PUBLIC_AWS_REGION=ap-northeast-1
NUXT_PUBLIC_USER_POOL_ID=your-user-pool-id
NUXT_PUBLIC_USER_POOL_CLIENT_ID=your-user-pool-client-id
```

#### 1.3 ビルド設定確認

`amplify.yml`がフロント専用になっていることを確認：

- backend セクションが削除されている
- frontend セクションのみ存在
- `npx nuxi generate`で静的サイト生成

### 2. GitHub Actions 設定

#### 2.1 リポジトリ Secrets 設定

GitHub リポジトリの「Settings」→「Secrets and variables」→「Actions」で以下を設定：

**AWS 認証情報:**

```
AWS_ACCESS_KEY_ID=your-access-key
AWS_SECRET_ACCESS_KEY=your-secret-key
AWS_REGION=ap-northeast-1
```

**Lambda 設定:**

```
LAMBDA_FUNCTION_NAME=incident-report-api-dev
```

**環境変数（本番）:**

```
AI_MODE=bedrock
DDB_REPORTS=incident-report-Reports-dev
BEDROCK_REGION=ap-northeast-1
BEDROCK_MODEL_ID=anthropic.claude-instant-v1
```

**環境変数（ステージング）:**

```
AI_MODE_STAGING=bedrock
DDB_REPORTS_STAGING=incident-report-Reports-staging
```

#### 2.2 IAM 権限設定

GitHub Actions の AWS ユーザーに以下の権限を付与：

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "lambda:UpdateFunctionCode",
        "lambda:UpdateFunctionConfiguration",
        "lambda:InvokeFunction"
      ],
      "Resource": [
        "arn:aws:lambda:ap-northeast-1:*:function:incident-report-api-dev",
        "arn:aws:lambda:ap-northeast-1:*:function:incident-report-api-dev-staging"
      ]
    }
  ]
}
```

### 3. ローカル環境での検証

#### 3.1 Lambda ビルドテスト

```bash
cd lambda
npm ci
npm run build
ls -lh index.js  # 1.3MB程度のファイルが生成されることを確認
```

#### 3.2 Docker 環境再現テスト（推奨）

```bash
docker run -it --rm -v "$PWD":/ws -w /ws aws/codebuild/standard:7.0 \
  bash -lc 'cd lambda && node -v && npm -v && npm ci && npm run build && zip -j function.zip index.js && unzip -l function.zip'
```

#### 3.3 フロントエンド ビルドテスト

```bash
npm ci
npm run build
npx nuxi generate
ls -la .output/public  # 静的ファイルが生成されることを確認
```

## デプロイフロー

### フロントエンド

1. `main`ブランチにプッシュ
2. Amplify が自動的にビルド・デプロイ
3. 静的サイトが更新される

### バックエンド

1. `lambda/`ディレクトリに変更をプッシュ
2. GitHub Actions が自動実行
3. Lambda 関数が更新される
4. ヘルスチェックで動作確認

## トラブルシューティング

### よくある問題

#### 1. ImportModuleError

**原因**: AWS SDK が外部化されている
**解決**: `lambda/package.json`の build スクリプトに`--external`オプションがないことを確認

#### 2. GitHub Actions 権限エラー

**原因**: IAM 権限不足
**解決**: 上記の IAM 権限を正しく設定

#### 3. 環境変数未設定エラー

**原因**: GitHub Secrets または Amplify 環境変数の設定漏れ
**解決**: 上記の環境変数設定を確認

### ログ確認方法

#### GitHub Actions

- リポジトリの「Actions」タブでワークフロー実行ログを確認

#### Amplify

- Amplify コンソールの「Build history」でビルドログを確認

#### Lambda

- CloudWatch Logs で実行ログを確認

## メンテナンス

### 定期的な確認事項

1. GitHub Actions の Node.js バージョン更新
2. AWS SDK のバージョン更新
3. esbuild のバージョン更新
4. セキュリティパッチの適用

### バックアップ

- Lambda 関数のコードは自動的に AWS でバージョン管理される
- GitHub リポジトリが完全なバックアップとして機能

## 利点

1. **責任分離**: フロントとバックエンドの問題を独立して解決可能
2. **透明性**: 各デプロイステップが明確に可視化
3. **確実性**: 環境差異を排除し、再現可能なビルド
4. **保守性**: 問題の切り分けが容易
5. **スケーラビリティ**: 各コンポーネントを独立してスケール可能
