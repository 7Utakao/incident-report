<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>インシデントダッシュボード（デモ）</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <style>
    /* ほんのりグラデーション背景 */
    body { background: linear-gradient(180deg,#eef6ff 0%, #f7fbff 60%, #ffffff 100%); }
  </style>
</head>
<body class="min-h-screen text-gray-900">
  <header class="py-8">
    <div class="max-w-7xl mx-auto px-6">
      <h1 class="text-3xl font-bold">ダッシュボード</h1>
      <p class="text-gray-500 mt-1">報告の分析と統計</p>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 pb-12 space-y-6">
    <!-- KPI: 総報告数（1枚だけ） -->
    <section class="grid grid-cols-1">
      <div class="rounded-2xl border bg-white/80 backdrop-blur p-6 shadow-sm">
        <div class="text-sm text-gray-500">総報告数</div>
        <div id="totalReports" class="mt-1 text-4xl font-semibold tracking-tight">—</div>
      </div>
    </section>

    <!-- グラフ 2枚（全期間 / 今月） -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="rounded-2xl border bg-white p-5 shadow-sm">
        <div class="mb-2 text-sm text-gray-500">カテゴリ別（全期間）Top10</div>
        <div class="h-80">
          <canvas id="chartAll" aria-label="カテゴリ別（全期間）棒グラフ" role="img"></canvas>
        </div>
      </div>
      <div class="rounded-2xl border bg-white p-5 shadow-sm">
        <div class="mb-2 text-sm text-gray-500">カテゴリ別（今月）Top10</div>
        <div class="h-80">
          <canvas id="chartMonth" aria-label="カテゴリ別（今月）棒グラフ" role="img"></canvas>
        </div>
      </div>
    </section>

    <!-- AI 総評（短文） -->
    <section class="rounded-2xl border bg-white p-5 shadow-sm">
      <div class="text-sm text-gray-500 mb-2">AIによる総評（デモ文）</div>
      <p id="advice" class="leading-relaxed">—</p>
    </section>

    <p class="text-xs text-gray-400">※ このデモはダミーデータで表示しています。API接続時は Cline に <code>/stats/categories?scope=all|month</code> を呼ぶように差し替えてください。</p>
  </main>

  <script>
    // ==========================
    //  デモ用ダミーデータ（置き換え想定）
    // ==========================
    const TOTAL_REPORTS = 47; // 実運用では /stats/categories?scope=all の totalReports を表示

    const ALL_TIME = [
      { code: 'WHY_PRCS_001', name: '手順未遵守', count: 12 },
      { code: 'WHY_OBS_001',  name: '観測性不足', count: 9 },
      { code: 'WHY_REQ_001',  name: '期待値合意不足', count: 7 },
      { code: 'WHY_MDL_003',  name: 'データ形式前提ズレ', count: 6 },
      { code: 'WHY_COST_001', name: '予算/アラート未設定', count: 5 },
      { code: 'WHY_JDG_001',  name: 'トレードオフ評価不足', count: 4 },
      { code: 'WHY_CFG_002',  name: 'CORS/プリフライト未対応', count: 2 }
    ];

    const THIS_MONTH = [
      { code: 'WHY_PRCS_001', name: '手順未遵守', count: 4 },
      { code: 'WHY_OBS_001',  name: '観測性不足', count: 3 },
      { code: 'WHY_MDL_003',  name: 'データ形式前提ズレ', count: 2 },
      { code: 'WHY_REQ_001',  name: '期待値合意不足', count: 1 }
    ];

    const SHORT_ADVICE = (() => {
      // 短く2文以内の要約（フォールバック）
      const top = THIS_MONTH[0] || ALL_TIME[0];
      if (!top) return '直近の傾向は確認中です。気づきがあれば短文でも構いません、まずは一件投稿してみましょう。';
      return `${top.name}が多いので、関連手順の見直しとダブルチェックを徹底しましょう。報告が少ない領域は見落としの可能性もあるため、気づいたら積極的に共有しましょう。`;
    })();

    // ==========================
    //  表示処理
    // ==========================
    document.getElementById('totalReports').textContent = TOTAL_REPORTS.toLocaleString('ja-JP');
    document.getElementById('advice').textContent = SHORT_ADVICE;

    function renderBarChart(canvasId, items) {
      const ctx = document.getElementById(canvasId);
      if (!ctx) return;
      const labels = items.map(x => x.name || x.code);
      const values = items.map(x => x.count);
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{ label: '報告数', data: values }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
        }
      });
    }

    renderBarChart('chartAll', ALL_TIME);
    renderBarChart('chartMonth', THIS_MONTH);
  </script>
</body>
</html>
