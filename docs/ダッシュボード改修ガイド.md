# ダッシュボード改修ガイド（Incident Report System）

> 目的：**実データ連動**の見やすいダッシュボードを実装する。KPI は「総報告数」1枚のみ。カテゴリ別の棒グラフを **全期間** と **今月** の2枚で表示し、最後に **短文の総評** を出す。

---

## 1. 変更範囲（Scope）
- ✅ KPI カードを **1枚（総報告数）** に統一（「本日の〜」カードは撤去）
- ✅ 棒グラフ：**カテゴリ別 TopN（全期間）**、**カテゴリ別 TopN（今月）**
- ✅ 総評：**2文以内の短文**（AI 失敗時はフォールバック文）
- ✅ 実データ連携：数値は **DynamoDB のレポート実データ**と一致すること
- ✅ 既存 UI は残しつつ、レイアウトとスタイルを **Tailwind** ベースで刷新

---

## 2. 完成イメージ（UI）
- 上段：カード 1枚「総報告数」
- 中段：左右に棒グラフ 2枚（左：全期間、右：今月）
- 下段：総評（短文）

> 参考デモ: `Dashboard_demo.html` （この内容を Nuxt ページに落とし込む）

---

## 3. データ仕様（API 契約）
### エンドポイント
- `GET /stats/categories?scope=all|month&topN=10&tz=Asia/Tokyo`

### レスポンス（例）
```json
{
  "ok": true,
  "scope": "month",
  "from": "2025-08-01T00:00:00+09:00",
  "to": "2025-08-31T23:59:59+09:00",
  "totalReports": 47,
  "byCategory": [
    { "code": "WHY_PRCS_001", "name": "手順未遵守", "count": 12 },
    { "code": "WHY_OBS_001",  "name": "観測性不足", "count": 9 }
  ],
  "advice": "手順未遵守が多いので、作業前チェックリストを徹底しましょう。",
  "updatedAt": "2025-08-22T02:22:00Z"
}
```

### マッピング規則（UI ↔ データ）
- **総報告数**：`totalReports`（`scope=all`）
- **カテゴリ別グラフ（全期間）**：`byCategory`（`scope=all`）
- **カテゴリ別グラフ（今月）**：`byCategory`（`scope=month&tz=Asia/Tokyo`）
- **総評**：`advice`（無い場合はフォールバック文を表示）

> 備考：レポート側のフィールドは `category: string` または `categories: string[]` のどちらでも対応可（複数カテゴリは加算）。

---

## 4. 作業タスク（Cline 用）
### 4.1 バックエンド
- [ ] `GET /stats/categories` を実装（`scope=all|month`, `topN`, `tz`）
- [ ] データ取得：DynamoDB **Scan → 追加集計**（開発規模）。将来は集計テーブル/ GSI 化
- [ ] `scope=month` は `createdAt` で当月のみ集計（`tz` を考慮）
- [ ] 返却フィールド：`totalReports`, `byCategory[{code,name,count}]`, `advice`, `updatedAt`
- [ ] フォールバック `advice` を内製（AI 失敗時含む）
- [ ] CORS と認証（現状の JWT 検証）を維持

### 4.2 フロントエンド
- [ ] ダッシュボードの KPI を **1枚のみ** に変更（総報告数）
- [ ] Chart.js で棒グラフ 2枚を実装（TopN は10）
- [ ] 読み込み/エラー/空データ時もレイアウト崩れないようプレースホルダ表示
- [ ] 総評は **2文以内**。`month.advice || all.advice` の順で採用
- [ ] 既存の「本日の〜」カードとダミー文言を撤去

### 4.3 デザイン（Tailwind 指針）
- カード：`rounded-2xl shadow-sm border bg-white/80 backdrop-blur p-5`
- タイポ：ラベル `text-sm text-gray-500`、値 `text-4xl font-semibold`
- グラフ高さ：`h-72`（固定）
- グリッド：`md:grid-cols-2`、余白は `gap-6` と `space-y-6`

---

## 5. 受け入れ基準（Acceptance Criteria）
- [ ] 画面上部の KPI が **総報告数**のみになっている
- [ ] 2枚の棒グラフ（全期間/今月）が表示され、**件数が DynamoDB と一致**
- [ ] 今月の範囲は `tz=Asia/Tokyo` で月初〜月末に基づく
- [ ] 総評が **2文以内**で表示され、AI 失敗時もフォールバックが出る
- [ ] ローディング・エラー時も UI が崩れない

---

## 6. 検証プロセス（手動テスト）
1. 既存データで `/stats/categories?scope=all` を確認し、`totalReports` と管理画面の総件数が一致
2. 任意カテゴリで **新規レポートを2件追加** → グラフの該当カテゴリが +2 されること
3. システム日付が当月であることを前提に、`scope=month` の対象に含まれること
4. AI 呼び出しを意図的に失敗（タイムアウト等）させても、**フォールバック文**が表示される

---

## 7. 運用・改善メモ
- スキャンで重くなったら：登録時に **集計テーブル** へ `ADD count :1` を同時更新（月次、通算の2キー）
- グラフの TopN は環境変数で調整可能にしておくと便利
- 総評は 120字程度・2文以内のスタイルに統一

---

## 8. よくある落とし穴
- `createdAt` のタイムゾーンずれ → `tz` を明示して月境界を計算
- カテゴリが `string[]` のときに **重複加算**していないか
- ダミー値が残って **実数と不一致**（必ず API の値だけで描画する）

---

## 9. 完了定義（DoD）
- [ ] 受け入れ基準を満たすスクリーンショット 3枚（KPI／全期間／今月）
- [ ] `/stats/categories` の JSON を添付（全期間/今月）
- [ ] 実データと合致したことを確認（テストの記録）

---

### 付録：フォールバック総評（テンプレ）
- 「**{Topカテゴリ名}** が多いので、関連手順の見直しとダブルチェックを徹底しましょう。報告が少ない領域は見落としの可能性もあるため、気づいたら積極的に共有しましょう。」

---

### Cline への依頼テンプレ
> 「`ダッシュボード改修ガイド.md` を読んで、**/stats/categories の実装 → フロントの接続 → UI 調整 → テスト**の順で進めてください。ガイドの受け入れ基準を満たすこと。既存のダミー数値は全て撤去し、画面は API の値のみで描画すること。」

